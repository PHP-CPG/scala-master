package de.tubs.ias.scama.logging

import org.scalatest.matchers.should.Matchers
import org.scalatest.wordspec.AnyWordSpec

class ResourceLoggerTest extends AnyWordSpec with Matchers {

  "getCpuUsage" should {
    "give me the current cpu usage" in {
      ResourceLogger.getCpuUsage > 0 shouldBe true
    }
  }
  "getRamUsage" should {
    "give me the current RAM usage" in {
      ResourceLogger.getRamUsage > 0 shouldBe true
    }
  }
  "process java ps line" should {
    "return none for non relevant java ps line" in {
      val psLine = """simon      39569  0.3  5.8 7735908 1916172 ?     Sl   Mar22  14:39 /usr/lib/jvm/default-runtime/bin/java -server -Xmx1536M -Dsbt.supershell=false -Didea.managed=true -Dfile.encoding=UTF-8 -Didea.installation.dir=/home/simon/tools/intellij -jar /home/simon/.local/share/JetBrains/IntelliJIdea2021.3/Scala/launcher/sbt-launch.jar early(addPluginSbtFile="/tmp/idea.sbt") ; set ideaPort in Global := 40185 ; idea-shell"""
      ResourceLogger.processJavaPsLine(psLine) shouldBe None
    }
    "return correct some for relevant java ps line" in {
      val psLine = """root      42255  992  1.0 44339728 5687576 ?    Sl   11:39   2:38 java -Xmx20g -Xss30m -XX:+UnlockDiagnosticVMOptions -XX:+ExitOnOutOfMemoryError -XX:AbortVMOnException=java.lang.StackOverflowError -cp /php-cpg/target/universal/stage/lib/io.joern.multilayer-php-cpg-generator-2.2.13.jar:/php-cpg/target/universal/stage/lib/io.joern.phpcpg-bytecode-layer-2.2.13.jar:/php-cpg/target/universal/stage/lib/io.joern.config-and-reporting-2.2.13.jar:/php-cpg/target/universal/stage/lib/io.joern.phpcpg-sourcecode-layer-2.2.13.jar:/php-cpg/target/universal/stage/lib/org.scala-lang.scala-library-2.13.3.jar:/php-cpg/target/universal/stage/lib/com.github.scopt.scopt_2.13-4.0.1.jar:/php-cpg/target/universal/stage/lib/io.shiftleft.codepropertygraph_2.13-1.3.493.jar:/php-cpg/target/universal/stage/lib/io.shiftleft.codepropertygraph-protos_2.13-1.3.493.jar:/php-cpg/target/universal/stage/lib/io.shiftleft.semanticcpg_2.13-1.3.493.jar:/php-cpg/target/universal/stage/lib/org.wvlet.airframe.airframe-log_2.13-21.12.0.jar:/php-cpg/target/universal/stage/lib/org.slf4j.slf4j-nop-1.7.32.jar:/php-cpg/target/universal/stage/lib/com.github.pathikrit.better-files_2.13-3.9.1.jar:/php-cpg/target/universal/stage/lib/org.scala-lang.modules.scala-parallel-collections_2.13-0.2.0.jar:/php-cpg/target/universal/stage/lib/commons-io.commons-io-2.8.0.jar:/php-cpg/target/universal/stage/lib/de.halcony.scala-argparse_2.13-1.1.11.jar:/php-cpg/target/universal/stage/lib/io.spray.spray-json_2.13-1.3.6.jar:/php-cpg/target/universal/stage/lib/com.lihaoyi.fastparse_2.13-2.2.2.jar:/php-cpg/target/universal/stage/lib/org.scala-lang.modules.scala-parser-combinators_2.13-1.1.2.jar:/php-cpg/target/universal/stage/lib/com.typesafe.config-1.4.1.jar:/php-cpg/target/universal/stage/lib/io.shiftleft.codepropertygraph-domain-classes_2.13-1.3.493.jar:/php-cpg/target/universal/stage/lib/io.shiftleft.overflowdb-traversal_2.13-1.102.jar:/php-cpg/target/universal/stage/lib/org.slf4j.slf4j-api-1.7.33.jar:/php-cpg/target/universal/stage/lib/com.google.protobuf.protobuf-java-3.10.0.jar:/php-cpg/target/universal/stage/lib/org.json4s.json4s-native_2.13-4.0.3.jar:/php-cpg/target/universal/stage/lib/org.scala-lang.modules.scala-collection-compat_2.13-2.6.0.jar:/php-cpg/target/universal/stage/lib/ch.qos.logback.logback-core-1.2.7.jar:/php-cpg/target/universal/stage/lib/com.lihaoyi.sourcecode_2.13-0.1.7.jar:/php-cpg/target/universal/stage/lib/com.lihaoyi.geny_2.13-0.4.2.jar:/php-cpg/target/universal/stage/lib/io.shiftleft.overflowdb-core-1.102.jar:/php-cpg/target/universal/stage/lib/net.oneandone.reflections8.reflections8-0.11.7.jar:/php-cpg/target/universal/stage/lib/com.massisframework.j-text-utils-0.3.4.jar:/php-cpg/target/universal/stage/lib/org.json4s.json4s-core_2.13-4.0.3.jar:/php-cpg/target/universal/stage/lib/org.json4s.json4s-native-core_2.13-4.0.3.jar:/php-cpg/target/universal/stage/lib/net.sf.trove4j.core-3.1.0.jar:/php-cpg/target/universal/stage/lib/org.msgpack.msgpack-core-0.9.0.jar:/php-cpg/target/universal/stage/lib/com.h2database.h2-mvstore-1.4.200.jar:/php-cpg/target/universal/stage/lib/org.javassist.javassist-3.22.0-GA.jar:/php-cpg/target/universal/stage/lib/com.google.guava.guava-21.0.jar:/php-cpg/target/universal/stage/lib/commons-lang.commons-lang-2.6.jar:/php-cpg/target/universal/stage/lib/au.com.bytecode.opencsv-2.4.jar:/php-cpg/target/universal/stage/lib/org.json4s.json4s-ast_2.13-4.0.3.jar:/php-cpg/target/universal/stage/lib/org.json4s.json4s-scalap_2.13-4.0.3.jar:/php-cpg/target/universal/stage/lib/com.thoughtworks.paranamer.paranamer-2.8.jar io.joern.Main /in/alex-LE:yourTinyTodo/ -f -o /out/cpg//alex-LE:yourTinyTodo.cpg -c /php-cpg/main.conf bytecode 8"""
      ResourceLogger.processJavaPsLine(psLine) shouldBe Some((42255,"""io.joern.Main /in/alex-LE:yourTinyTodo/ -f -o /out/cpg//alex-LE:yourTinyTodo.cpg -c /php-cpg/main.conf bytecode 8"""))
    }
    "return correct some for consumer java ps line" in {
      val psLine = """root     128034  106  0.8 32561540 4292428 ?    Sl   11:57   7:42 java -Xmx20g -Xss30m -XX:+UnlockDiagnosticVMOptions -XX:+ExitOnOutOfMemoryError -XX:AbortVMOnException=java.lang.StackOverflowError -cp /surf/target/universal/stage/lib/default.surf-0.1.jar:/surf/target/universal/stage/lib/org.scala-lang.scala-library-2.13.6.jar:/surf/target/universal/stage/lib/io.joern.phpcpg-bytecode-layer_2.13-2.2.13.jar:/surf/target/universal/stage/lib/io.shiftleft.codepropertygraph_2.13-1.3.493.jar:/surf/target/universal/stage/lib/io.shiftleft.codepropertygraph-protos_2.13-1.3.493.jar:/surf/target/universal/stage/lib/io.shiftleft.semanticcpg_2.13-1.3.493.jar:/surf/target/universal/stage/lib/org.wvlet.airframe.airframe-log_2.13-21.12.1.jar:/surf/target/universal/stage/lib/io.spray.spray-json_2.13-1.3.6.jar:/surf/target/universal/stage/lib/io.joern.config-and-reporting_2.13-2.2.13.jar:/surf/target/universal/stage/lib/com.github.scopt.scopt_2.13-4.0.1.jar:/surf/target/universal/stage/lib/org.slf4j.slf4j-nop-1.7.32.jar:/surf/target/universal/stage/lib/com.github.pathikrit.better-files_2.13-3.9.1.jar:/surf/target/universal/stage/lib/org.scala-lang.modules.scala-parallel-collections_2.13-0.2.0.jar:/surf/target/universal/stage/lib/commons-io.commons-io-2.8.0.jar:/surf/target/universal/stage/lib/de.halcony.scala-argparse_2.13-1.1.11.jar:/surf/target/universal/stage/lib/com.lihaoyi.fastparse_2.13-2.2.2.jar:/surf/target/universal/stage/lib/io.shiftleft.codepropertygraph-domain-classes_2.13-1.3.493.jar:/surf/target/universal/stage/lib/io.shiftleft.overflowdb-traversal_2.13-1.102.jar:/surf/target/universal/stage/lib/org.slf4j.slf4j-api-1.7.33.jar:/surf/target/universal/stage/lib/com.google.protobuf.protobuf-java-3.10.0.jar:/surf/target/universal/stage/lib/org.json4s.json4s-native_2.13-4.0.3.jar:/surf/target/universal/stage/lib/org.scala-lang.modules.scala-collection-compat_2.13-2.6.0.jar:/surf/target/universal/stage/lib/ch.qos.logback.logback-core-1.2.8.jar:/surf/target/universal/stage/lib/com.typesafe.config-1.4.1.jar:/surf/target/universal/stage/lib/com.lihaoyi.sourcecode_2.13-0.1.7.jar:/surf/target/universal/stage/lib/com.lihaoyi.geny_2.13-0.4.2.jar:/surf/target/universal/stage/lib/io.shiftleft.overflowdb-core-1.102.jar:/surf/target/universal/stage/lib/net.oneandone.reflections8.reflections8-0.11.7.jar:/surf/target/universal/stage/lib/com.massisframework.j-text-utils-0.3.4.jar:/surf/target/universal/stage/lib/org.json4s.json4s-core_2.13-4.0.3.jar:/surf/target/universal/stage/lib/org.json4s.json4s-native-core_2.13-4.0.3.jar:/surf/target/universal/stage/lib/net.sf.trove4j.core-3.1.0.jar:/surf/target/universal/stage/lib/org.msgpack.msgpack-core-0.9.0.jar:/surf/target/universal/stage/lib/com.h2database.h2-mvstore-1.4.200.jar:/surf/target/universal/stage/lib/org.javassist.javassist-3.22.0-GA.jar:/surf/target/universal/stage/lib/com.google.guava.guava-21.0.jar:/surf/target/universal/stage/lib/commons-lang.commons-lang-2.6.jar:/surf/target/universal/stage/lib/au.com.bytecode.opencsv-2.4.jar:/surf/target/universal/stage/lib/org.json4s.json4s-ast_2.13-4.0.3.jar:/surf/target/universal/stage/lib/org.json4s.json4s-scalap_2.13-4.0.3.jar:/surf/target/universal/stage/lib/com.thoughtworks.paranamer.paranamer-2.8.jar de.tubs.ias.surf.Main /out/cpg//thenbrent:paypal-digital-goods.cpg"""
      ResourceLogger.processJavaPsLine(psLine) shouldBe Some((128034,"""de.tubs.ias.surf.Main /out/cpg//thenbrent:paypal-digital-goods.cpg"""))
    }
  }
  "getJavaProcesses" should {
    "give me the running java processes" in {
      println(ResourceLogger.getJavaProcesses)
      ResourceLogger.getJavaProcesses.nonEmpty shouldBe true
    }
  }

}
